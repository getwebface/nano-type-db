name = "nanotype-db"
main = "src/index.ts"
compatibility_date = "2024-04-05"
compatibility_flags = ["nodejs_compat"]

# Define the Durable Object binding
[[durable_objects.bindings]]
name = "DATA_STORE"
class_name = "NanoStore" # Changed from DataStore to force SQLite creation

# Database migrations
[[migrations]]
tag = "v2"
new_sqlite_classes = ["NanoStore"] # Must use new_sqlite_classes for SQL support

# Backups
[[r2_buckets]]
binding = "BACKUP_BUCKET"
bucket_name = "nanotype-backups"

# Auth Database (D1)
[[d1_databases]]
binding = "AUTH_DB"
database_name = "nanotype-auth"
database_id = "d1b3a27b-a1de-43ab-ba7f-5ebda88b9807"

# Read Replica Database (D1) - For distributed read operations
# IMPORTANT: Replace 'placeholder-read-replica-id' with your actual database ID
# Run: wrangler d1 create nanotype-read-replica
# Then copy the database_id from the output
[[d1_databases]]
binding = "READ_REPLICA"
database_name = "nanotype-read-replica"
database_id = "3c7e5378-398d-4ddd-acd4-65d808aa454a"

# Observability Configuration
[observability]
enabled = false
head_sampling_rate = 1

[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

[observability.traces]
enabled = false
head_sampling_rate = 1

# Vector Index & AI
[[vectorize]]
binding = "VECTOR_INDEX"
index_name = "nanotype-vectors"

[ai]
binding = "AI"

# Static Assets (React Frontend)
[assets]
binding = "ASSETS"
directory = "./dist"

# Rate Limit (Optional - uncomment if you have a namespace)
# [[rate_limits]]
# binding = "RATE_LIMITER"
# namespace_id = "<namespace-id>"
# simple = { limit = 100, period = 60 }

# Cron Trigger for Backups (Every hour)
[triggers]
crons = ["0 * * * *"]

# Cloudflare Queues for AI Embedding Reliability
[[queues.producers]]
binding = "AI_EMBEDDING_QUEUE"
queue = "ai-embedding-queue"

[[queues.consumers]]
queue = "ai-embedding-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "ai-embedding-dlq"

# Cloudflare Queues for Webhooks
[[queues.producers]]
binding = "WEBHOOK_QUEUE"
queue = "webhook-queue"

[[queues.consumers]]
queue = "webhook-queue"
max_batch_size = 10
max_batch_timeout = 30

# Analytics Engine for Observability
[[analytics_engine_datasets]]
binding = "ANALYTICS"
