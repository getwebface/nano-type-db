name = "nanotype-db"
main = "src/index.ts"
compatibility_date = "2026-02-06"
compatibility_flags = ["nodejs_compat"]

# --- PREVIEW CONFIGURATION ---
# DISABLING PREVIEW URLS IS REQUIRED FOR DURABLE OBJECTS
preview_urls = false

# --- DURABLE OBJECTS ---
[[durable_objects.bindings]]
name = "DATA_STORE"
class_name = "NanoStore"

[[migrations]]
tag = "v2"
new_sqlite_classes = ["NanoStore"]

# --- FIX: USE WORKER SITES INSTEAD OF ASSETS ---
# This bypasses the Preview URL versioning error entirely.
[site]
bucket = "./dist" 

# --- DATABASES ---
[[d1_databases]]
binding = "AUTH_DB"
database_name = "nanotype-auth"
database_id = "d1b3a27b-a1de-43ab-ba7f-5ebda88b9807"

[[d1_databases]]
binding = "READ_REPLICA"
database_name = "nanotype-read-replica"
database_id = "3c7e5378-398d-4ddd-acd4-65d808aa454a"

[[vectorize]]
binding = "VECTOR_INDEX"
index_name = "nanotype-vectors"

# --- AI & ANALYTICS ---
[ai]
binding = "AI"
gateway = "nano-type-ai-gateway"

[[analytics_engine_datasets]]
binding = "ANALYTICS"

[[analytics_engine_datasets]]
binding = "ANALYTICS_ALT"

# --- QUEUES ---
# AI Embeddings
[[queues.producers]]
binding = "EMBEDDING_QUEUE"
queue = "nanotype-embeddings"

[[queues.consumers]]
queue = "nanotype-embeddings"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 5
dead_letter_queue = "nanotype-embeddings-dlq"

# AI Reliability
[[queues.producers]]
binding = "AI_EMBEDDING_QUEUE"
queue = "ai-embedding-queue"

[[queues.consumers]]
queue = "ai-embedding-queue"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "ai-embedding-dlq"

# Webhooks (Standard)
[[queues.producers]]
binding = "WEBHOOK_QUEUE"
queue = "webhook-queue"

[[queues.consumers]]
queue = "webhook-queue"
max_batch_size = 10
max_batch_timeout = 30

# Webhooks (Nanotype Specific)
[[queues.producers]]
binding = "WEBHOOK_QUEUE_NANOTYPE"
queue = "nanotype-webhooks"

[[queues.consumers]]
queue = "nanotype-webhooks"
max_batch_size = 10
max_batch_timeout = 30
max_retries = 3
dead_letter_queue = "nanotype-webhooks-dlq"

# --- CONFIGURATION ---
[observability.logs]
enabled = true
head_sampling_rate = 1
invocation_logs = true

[triggers]
crons = ["0 * * * *"]