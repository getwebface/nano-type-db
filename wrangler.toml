name = "nanotype-db"
main = "src/index.ts"
compatibility_date = "2024-04-05"
compatibility_flags = ["nodejs_compat"]

# Define the Durable Object binding
[[durable_objects.bindings]]
name = "DATA_STORE"
class_name = "DataStore"

# Database migrations
[[migrations]]
tag = "v1"
new_classes = ["DataStore"]

# Rules for SQLite storage
[durable_objects]
bindings = [
  { name = "DATA_STORE", class_name = "DataStore" }
]

# Backups
[[r2_buckets]]
binding = "BACKUP_BUCKET"
bucket_name = "nanotype-backups"

# Auth Database (D1)
[[d1_databases]]
binding = "AUTH_DB"
database_name = "nanotype-auth"
database_id = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" # Run `npx wrangler d1 create nanotype-auth` to get ID

# Rate Limiting
# Note: You must run `npx wrangler kv:namespace create RATE_LIMITER` or create a Rate Limit namespace in dashboard 
# and replace namespace_id below. Using a placeholder for now.
[[rate_limits]]
binding = "RATE_LIMITER"
namespace_id = "1001"
simple = { limit = 100, period = 60 } # 100 reqs per 60s

# 1. The Vector Database (Stores the numbers)
[[vectorize]]
binding = "VECTOR_INDEX"
index_name = "nanotype-vectors"

# 2. The AI Brain (Generates the numbers)
[ai]
binding = "AI"

# Cron Trigger for Backups (Every hour)
[triggers]
crons = ["0 * * * *"]
